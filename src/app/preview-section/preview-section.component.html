<!-- Preview Section -->
<div
  class="preview-section"
  [class.has-popup-actions]="
    isPopupMode && !isAppReadOnly() && showToolboxActions
  "
  *ngIf="previewData.currentApp"
>
  <div class="preview-header" *ngIf="!isPopupMode">
    <h3>
      <span class="emoji">ğŸ“±</span>
      {{ t("livePreview") }}
      <span *ngIf="isAppReadOnly()" class="read-only-badge">{{
        t("readOnly")
      }}</span>
    </h3>
    <div class="preview-actions" *ngIf="!isAppReadOnly() && showToolboxActions">
      <!-- App Status Info -->
      <div class="app-status-info" *ngIf="isAppSaved()">
        <span class="status-badge saved">
          <span class="emoji">ğŸ’¾</span>
          <span>Saved</span>
        </span>
      </div>

      <!-- Modify Button - Always visible -->
      <button
        class="action-btn modify icon-only"
        (click)="onModifyClick()"
        title="Make it better! âœ¨"
      >
        <span class="action-icon">âœ¨</span>
      </button>

      <!-- Save/Update Button - Always visible -->
      <button
        class="action-btn save-toolbox icon-only"
        (click)="onSaveToToolboxClick()"
        [title]="
          isAppSaved() ? 'Update in My Toolbox ğŸ“¦' : 'Save to My Toolbox ğŸ“¦'
        "
      >
        <span class="action-icon">ğŸ“¦</span>
      </button>

      <!-- Publish Button - Always visible -->
      <button
        class="action-btn save-appstore icon-only"
        (click)="onAddToAppStoreClick()"
        title="Publish for Everyone ğŸŒ"
      >
        <span class="action-icon">ğŸŒ</span>
      </button>

      <!-- Full View Button -->
      <button
        class="action-btn popup icon-only"
        (click)="onOpenInPopup()"
        title="Make it Bigger! ğŸ”"
      >
        <span class="action-icon">ğŸ”</span>
      </button>

      <!-- Share Button - Only enabled if app can be shared -->
      <button
        class="action-btn share icon-only"
        (click)="onShareApp()"
        [disabled]="!canShareApp()"
        [title]="
          !canShareApp()
            ? 'Save first, then share! ğŸ’¾'
            : 'Share This Cool App! ğŸš€'
        "
      >
        <span class="action-icon">ğŸš€</span>
      </button>

      <!-- Clear Button -->
      <button
        class="action-btn clear icon-only"
        (click)="onClearClick()"
        title="Start Over Fresh! ğŸ—‘ï¸"
      >
        <span class="action-icon">ğŸ—‘ï¸</span>
      </button>
    </div>
  </div>

  <!-- Popup Mode Actions - Show action buttons when in popup mode -->
  <div
    class="popup-actions"
    *ngIf="isPopupMode && !isAppReadOnly() && showToolboxActions"
  >
    <div class="action-buttons-row">
      <button
        class="action-btn modify icon-only"
        (click)="onModifyClick()"
        title="Make it better! âœ¨"
      >
        <span class="action-icon">âœ¨</span>
      </button>
      <button
        class="action-btn save-toolbox icon-only"
        (click)="onSaveToToolboxClick()"
        [title]="
          isAppSaved() ? 'Update in My Toolbox ğŸ“¦' : 'Save to My Toolbox ğŸ“¦'
        "
      >
        <span class="action-icon">ğŸ“¦</span>
      </button>
      <button
        class="action-btn save-appstore icon-only"
        (click)="onAddToAppStoreClick()"
        title="Publish for Everyone ğŸŒ"
      >
        <span class="action-icon">ğŸŒ</span>
      </button>
      <button
        class="action-btn share icon-only"
        (click)="onShareApp()"
        [disabled]="!canShareApp()"
        [title]="
          !canShareApp()
            ? 'Save first, then share! ğŸ’¾'
            : 'Share This Cool App! ğŸš€'
        "
      >
        <span class="action-icon">ğŸš€</span>
      </button>
      <!-- Note: "Open in Full View" button is excluded as we're already in popup mode -->
      <!-- Note: "Clear" button is excluded as it would close the popup unexpectedly -->
    </div>
  </div>

  <!-- App Store Project Info (only when previewing from App Store and not in popup mode) -->
  <div class="app-store-info" *ngIf="isAppStorePreview() && !isPopupMode">
    <div class="project-info">
      <h4>{{ previewData.sourceProject?.name }}</h4>
      <p class="author">
        by
        {{
          previewData.sourceProject?.user?.name ||
            previewData.sourceProject?.user?.username
        }}
      </p>
    </div>
    <div class="star-section">
      <button
        class="star-btn"
        [class.starred]="previewData.sourceProject?.starred"
        (click)="onStarProject()"
      >
        <span class="star-icon">{{
          previewData.sourceProject?.starred ? "â­" : "â˜†"
        }}</span>
        <span class="star-count">{{
          previewData.sourceProject?.starCount || 0
        }}</span>
      </button>
    </div>
  </div>

  <div class="preview-container">
    <iframe
      [src]="previewData.safePreviewUrl"
      class="preview-frame"
      title="Generated App Preview"
      sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-presentation allow-downloads"
      (load)="onIframeLoad($event)"
      (error)="onIframeError($event)"
    >
    </iframe>

    <!-- Loading overlay -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">
          {{ t("modifyingApp") || "Modifying your app..." }}
        </p>
      </div>
    </div>
  </div>
</div>
